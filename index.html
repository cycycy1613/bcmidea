<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CM RE Referral System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f4f4f4; margin: 0; padding: 2rem; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; }
    .hide { display: none; }
    .login-btn { display: block; margin: auto; padding: 0.75rem 1.5rem; font-size: 1rem; background-color: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .profile, .admin-section, .user-section { margin-top: 2rem; }
    .url-group { display: flex; margin-bottom: 0.5rem; }
    .url-group input { flex: 1; padding: 0.5rem; border-radius: 6px 0 0 6px; border: 1px solid #ccc; }
    .url-group button { padding: 0.5rem 1rem; background: #007bff; color: #fff; border: none; border-radius: 0 6px 6px 0; cursor: pointer; }
    .admin-box { background: #ccc; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
    .admin-url { display: flex; margin-bottom: 0.5rem; }
    .admin-url input { flex: 1; padding: 0.4rem; margin-right: 0.5rem; border-radius: 4px; border: 1px solid #aaa; }
    .admin-url button { border: none; cursor: pointer; padding: 0.4rem 0.6rem; border-radius: 4px; font-size: 1rem; color: white; }
    .approve { background-color: #4CAF50; margin-right: 0.25rem; }
    .reject { background-color: #f44336; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>CM RE Referral System</h1>
    <button id="loginBtn" class="login-btn">Login with Google</button><div id="userSection" class="user-section hide">
  <h2>User Dashboard</h2>
  <div id="profile"></div>
  <div id="urlInputs"></div>
</div>

<div id="adminSection" class="admin-section hide">
  <h2>Admin Dashboard</h2>
  <div id="totalUsers">Total Users: 000</div>
  <div id="submissions"></div>
</div>

  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBf_N0k7XsnCu-482nOwVuYFDZ7m7Q44gE",
      authDomain: "cm-re-referrals.firebaseapp.com",
      projectId: "cm-re-referrals",
      storageBucket: "cm-re-referrals.appspot.com",
      messagingSenderId: "675851835919",
      appId: "1:675851835919:web:9225f1800976d7818f617a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.getElementById('loginBtn').onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    auth.onAuthStateChanged(async user => {
      if (!user) return;
      document.getElementById('loginBtn').style.display = 'none';

      if (user.email === 'brocyronmathew97@gmail.com') {
        document.getElementById('adminSection').classList.remove('hide');
        loadAdminDashboard();
        return;
      }

      document.getElementById('userSection').classList.remove('hide');
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({ name: user.displayName, email: user.email, dateJoined: firebase.firestore.FieldValue.serverTimestamp(), points: 0 });
      }
      const userData = (await userRef.get()).data();
      document.getElementById('profile').innerHTML = `
        <strong>${userData.name}</strong><br>
        Email: ${userData.email}<br>
        Points: ${userData.points}
      `;
      const today = new Date().toLocaleDateString();
      const subRef = db.collection('submissions').doc(`${user.uid}_${today}`);
      const subDoc = await subRef.get();
      const submitted = subDoc.exists ? subDoc.data().urls.length : 0;
      const urlInputs = document.getElementById('urlInputs');
      for (let i = 0; i < 5 - submitted; i++) {
        const group = document.createElement('div');
        group.className = 'url-group';
        group.innerHTML = `<input type="text" placeholder="Paste FB post URL"><button>Submit</button>`;
        const input = group.querySelector('input');
        const btn = group.querySelector('button');
        btn.onclick = async () => {
          const url = input.value.trim();
          if (!url) return alert('Please enter a URL');
          await subRef.set({
            uid: user.uid,
            urls: firebase.firestore.FieldValue.arrayUnion(url),
            dateSubmitted: firebase.firestore.FieldValue.serverTimestamp(),
            verified: []
          }, { merge: true });
          alert('Submitted! Refresh to see updated slots.');
        };
        urlInputs.appendChild(group);
      }
    });

    async function loadAdminDashboard() {
      const usersSnap = await db.collection('users').get();
      document.getElementById('totalUsers').innerText = `Total Users: ${usersSnap.size.toString().padStart(3, '0')}`;
      const submissions = await db.collection('submissions').get();
      const container = document.getElementById('submissions');

      for (const doc of submissions.docs) {
        const data = doc.data();
        const userDoc = await db.collection('users').doc(data.uid).get();
        const name = userDoc.exists ? userDoc.data().name : 'Unknown';

        const box = document.createElement('div');
        box.className = 'admin-box';
        box.innerHTML = `<h4>${name}</h4>`;

        data.urls.forEach((url, index) => {
          const row = document.createElement('div');
          row.className = 'admin-url';

          const input = document.createElement('input');
          input.value = url; input.readOnly = true;

          const approve = document.createElement('button');
          approve.className = 'approve';
          approve.innerText = '👍';
          approve.onclick = async () => {
            await db.collection('submissions').doc(doc.id).update({ [`verified.${index}`]: true });
            await db.collection('users').doc(data.uid).update({ points: firebase.firestore.FieldValue.increment(1) });
            row.remove(); cleanup(doc.id);
          };

          const reject = document.createElement('button');
          reject.className = 'reject';
          reject.innerText = '👎';
          reject.onclick = async () => {
            data.urls.splice(index, 1);
            await db.collection('submissions').doc(doc.id).update({ urls: data.urls });
            row.remove(); cleanup(doc.id);
          };

          row.appendChild(input);
          row.appendChild(approve);
          row.appendChild(reject);
          box.appendChild(row);
        });

        container.appendChild(box);
      }
    }

    async function cleanup(docId) {
      const ref = db.collection('submissions').doc(docId);
      const snap = await ref.get();
      if (snap.exists && snap.data().urls.length === 0) await ref.delete();
    }
  </script></body>
</html>
